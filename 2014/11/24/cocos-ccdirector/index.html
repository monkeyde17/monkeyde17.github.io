<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>cocos2dx 3.0 ---- Director | Hexo</title>
  <meta name="author" content="John Doe">
  
  <meta name="description" content="Director – 导演类

管理场景Scene
实例化各种全局XXXX
绑定GLView

路径12cocos/2d/CCDirector.hcocos/2d/CCDirector.cpp
源码分析先上一盘头文件。
1234567891011121314151617181920212223242">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="cocos2dx 3.0 ---- Director"/>
  <meta property="og:site_name" content="Hexo"/>

  
    <meta property="og:image" content="undefined"/>
  

  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">  
  <link rel="stylesheet" href="/css/sidenav.css" media="screen" type="text/css">  
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  

</head>

<body id="body" data-spy="scroll" data-target=".toc">
  <div class="container" id="container">
	<div class="content">
	  <div class="page-header">		
  <h1><a class="brand" href="/">Hexo</a><span class="split"></span><span class="title">cocos2dx 3.0 ---- Director</span><span class="date" id="title-date"><i class="fa fa-clock-o"></i> 2014-11-24</span></h1>
</div>		

<div class="row page">
  <!-- cols -->	
  
  <div class="col-xs-12 col-sm-3 col-md-3 toc"> 
	<!-- toc -->
<script type="text/javascript">
		jQuery(document).ready(function() {
 		   generateWikiTOC('.note', '.toc',  2 , 2 );
		});
</script>
  </div><!-- col-md-3 -->
  
  

  
  <div class="col-xs-12 col-sm-9 col-md-9 note">
	

	  <!-- content -->
	  <p><code>Director</code> – 导演类</p>
<ul>
<li>管理场景<code>Scene</code></li>
<li>实例化各种全局XXXX</li>
<li>绑定GLView</li>
</ul>
<h2 id="u8DEF_u5F84"><a href="#u8DEF_u5F84" class="headerlink" title="路径"></a>路径</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cocos/<span class="number">2</span>d/CCDirector.h</span><br><span class="line">cocos/<span class="number">2</span>d/CCDirector.cpp</span><br></pre></td></tr></table></figure>
<h2 id="u6E90_u7801_u5206_u6790"><a href="#u6E90_u7801_u5206_u6790" class="headerlink" title="源码分析"></a>源码分析</h2><p>先上一盘头文件。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> CC_DLL Director : <span class="keyword">public</span> Ref</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *EVENT_PROJECTION_CHANGED;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* EVENT_AFTER_UPDATE;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* EVENT_AFTER_VISIT;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* EVENT_AFTER_DRAW;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 导演类投影 */</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="keyword">class</span> Projection</span><br><span class="line">    &#123;</span><br><span class="line">        _2D,</span><br><span class="line">        _3D, <span class="comment">/* fovy=60, znear=0.5f, zfar=1500 */</span></span><br><span class="line">        CUSTOM,</span><br><span class="line">        DEFAULT = _3D,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 实例 */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Director* <span class="title">getInstance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">CC_DEPRECATED_ATTRIBUTE <span class="keyword">static</span> Director* <span class="title">sharedDirector</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Director::getInstance(); &#125;</span><br><span class="line"></span><br><span class="line">    Director(<span class="keyword">void</span>);</span><br><span class="line">    <span class="keyword">virtual</span> ~Director();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">init</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/********/</span></span><br><span class="line">    <span class="comment">/* 属性 */</span></span><br><span class="line">    <span class="comment">/********/</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> Scene* <span class="title">getRunningScene</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _runningScene; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">double</span> <span class="title">getAnimationInterval</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _animationInterval; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">setAnimationInterval</span><span class="params">(<span class="keyword">double</span> interval)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">isDisplayStats</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _displayStats; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">setDisplayStats</span><span class="params">(<span class="keyword">bool</span> displayStats)</span> </span>&#123; _displayStats = displayStats; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">float</span> <span class="title">getSecondsPerFrame</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _secondsPerFrame; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> GLView* <span class="title">getOpenGLView</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _openGLView; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setOpenGLView</span><span class="params">(GLView *openGLView)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">TextureCache* <span class="title">getTextureCache</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">isNextDeltaTimeZero</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _nextDeltaTimeZero; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setNextDeltaTimeZero</span><span class="params">(<span class="keyword">bool</span> nextDeltaTimeZero)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">isPaused</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _paused; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">getTotalFrames</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _totalFrames; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">inline</span> Projection <span class="title">getProjection</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _projection; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setProjection</span><span class="params">(Projection projection)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setViewport</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">isSendCleanupToScene</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _sendCleanupToScene; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Node* <span class="title">getNotificationNode</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _notificationNode; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setNotificationNode</span><span class="params">(Node *node)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">const</span> Size&amp; <span class="title">getWinSize</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Size <span class="title">getWinSizeInPixels</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">Size <span class="title">getVisibleSize</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">Point <span class="title">getVisibleOrigin</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">Point <span class="title">convertToGL</span><span class="params">(<span class="keyword">const</span> Point&amp; point)</span></span>;</span><br><span class="line">    <span class="function">Point <span class="title">convertToUI</span><span class="params">(<span class="keyword">const</span> Point&amp; point)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">getZEye</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/************/</span></span><br><span class="line">    <span class="comment">/* 场景管理 */</span></span><br><span class="line">    <span class="comment">/************/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 第一个场景调用 */</span></span><br><span class="line">    <span class="comment">/* 先入场景栈，再调用 startAnimation */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">runWithScene</span><span class="params">(Scene *scene)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 入场景栈 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushScene</span><span class="params">(Scene *scene)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 出场景栈 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">popScene</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 除了场景栈栈底元素，其余都出栈 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">popToRootScene</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 出栈，知道栈中只剩 Level 个元素 */</span></span><br><span class="line"> 	<span class="function"><span class="keyword">void</span> <span class="title">popToSceneStackLevel</span><span class="params">(<span class="keyword">int</span> level)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 替换当前栈顶元素 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">replaceScene</span><span class="params">(Scene *scene)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 结束Direcotr场景管理 */</span></span><br><span class="line">    <span class="comment">/* 其实只是将一个标志位设置为false */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">end</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 暂停当前场景 */</span></span><br><span class="line">    <span class="comment">/* 而且FPS会降低至4 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 恢复当前场景 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">resume</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 停止绘制 */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">stopAnimation</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 开始绘制 */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">startAnimation</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 每一帧绘制调用 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">drawScene</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/************/</span></span><br><span class="line">    <span class="comment">/* 内存管理 */</span></span><br><span class="line">    <span class="comment">/************/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 清理缓存 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">purgeCachedData</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 根据Configuration设置默认值 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDefaultValues</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***************/</span></span><br><span class="line">    <span class="comment">/* openGL 相关 */</span></span><br><span class="line">    <span class="comment">/***************/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置openGL默认值 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setGLDefaultValues</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 混合 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAlphaBlending</span><span class="params">(<span class="keyword">bool</span> on)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 深度测试 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDepthTest</span><span class="params">(<span class="keyword">bool</span> on)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 主循环 */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">mainLoop</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setContentScaleFactor</span><span class="params">(<span class="keyword">float</span> scaleFactor)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">getContentScaleFactor</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _contentScaleFactor; &#125;</span><br><span class="line">    <span class="function">Scheduler* <span class="title">getScheduler</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _scheduler; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setScheduler</span><span class="params">(Scheduler* scheduler)</span></span>;</span><br><span class="line">    <span class="function">ActionManager* <span class="title">getActionManager</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _actionManager; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setActionManager</span><span class="params">(ActionManager* actionManager)</span></span>;</span><br><span class="line">    <span class="function">EventDispatcher* <span class="title">getEventDispatcher</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _eventDispatcher; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setEventDispatcher</span><span class="params">(EventDispatcher* dispatcher)</span></span>;</span><br><span class="line">    <span class="function">Renderer* <span class="title">getRenderer</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _renderer; &#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span>  (CC_TARGET_PLATFORM != CC_PLATFORM_WINRT) &amp;&amp; (CC_TARGET_PLATFORM != CC_PLATFORM_WP8)</span></span><br><span class="line">    <span class="function">Console* <span class="title">getConsole</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _console; &#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">getDeltaTime</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">getFrameRate</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _frameRate; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">purgeDirector</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">bool</span> _purgeDirectorInNextLoop; <span class="comment">// this flag will be set to true in end()</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setNextScene</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showStats</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createStatsLabel</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">calculateMPF</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getFPSImageData</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span>** datapointer, ssize_t* length)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">calculateDeltaTime</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initTextureCache</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroyTextureCache</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    Scheduler *_scheduler;</span><br><span class="line">    ActionManager *_actionManager;</span><br><span class="line">    EventDispatcher* _eventDispatcher;</span><br><span class="line">    EventCustom *_eventProjectionChanged, *_eventAfterDraw, *_eventAfterVisit, *_eventAfterUpdate;</span><br><span class="line">        </span><br><span class="line">	<span class="keyword">float</span> _deltaTime;</span><br><span class="line">    </span><br><span class="line">    GLView *_openGLView;</span><br><span class="line"></span><br><span class="line">    TextureCache *_textureCache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> _animationInterval;</span><br><span class="line">    <span class="keyword">double</span> _oldAnimationInterval;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> _landscape;</span><br><span class="line">    <span class="keyword">bool</span> _displayStats;</span><br><span class="line">    <span class="keyword">float</span> _accumDt;</span><br><span class="line">    <span class="keyword">float</span> _frameRate;</span><br><span class="line">    </span><br><span class="line">    LabelAtlas *_FPSLabel;</span><br><span class="line">    LabelAtlas *_drawnBatchesLabel;</span><br><span class="line">    LabelAtlas *_drawnVerticesLabel;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">bool</span> _paused;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> _totalFrames;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> _frames;</span><br><span class="line">    <span class="keyword">float</span> _secondsPerFrame;</span><br><span class="line">    </span><br><span class="line">    Scene *_runningScene;</span><br><span class="line">    Scene *_nextScene;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">bool</span> _sendCleanupToScene;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 场景栈 */</span></span><br><span class="line">    Vector&lt;Scene*&gt; _scenesStack;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> timeval *_lastUpdate;</span><br><span class="line">    <span class="keyword">bool</span> _nextDeltaTimeZero;</span><br><span class="line">    Projection _projection;</span><br><span class="line">    Size _winSizeInPoints;</span><br><span class="line">    <span class="keyword">float</span> _contentScaleFactor;</span><br><span class="line">    Node *_notificationNode;</span><br><span class="line">    Renderer *_renderer;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span>  (CC_TARGET_PLATFORM != CC_PLATFORM_WINRT) &amp;&amp; (CC_TARGET_PLATFORM != CC_PLATFORM_WP8)</span></span><br><span class="line">    Console *_console;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> GLViewProtocol;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 只支持60，30，15 FPS */</span></span><br><span class="line"><span class="keyword">class</span> DisplayLinkDirector : <span class="keyword">public</span> Director</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    DisplayLinkDirector() </span><br><span class="line">        : _invalid(<span class="literal">false</span>)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">mainLoop</span><span class="params">()</span> override</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">setAnimationInterval</span><span class="params">(<span class="keyword">double</span> value)</span> override</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">startAnimation</span><span class="params">()</span> override</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">stopAnimation</span><span class="params">()</span> override</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">bool</span> _invalid;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>看了头文件之后，大概就有了一个了解<br>头文件的注释中表明基于<code>Director</code>的子类或许会有4个，之后由于只需要<code>DisplayLinkDirector</code>，便只实现了这个。</p>
<p>看过头文件之后便把把内容划分成以下几个模块：</p>
<ul>
<li><a href="/./#Director实例化">Director实例化</a></li>
<li><a href="/./#Director主循环">Director主循环</a></li>
<li><a href="/./#Director场景管理">Director场景管理</a></li>
</ul>
<h3 id="Director_u5B9E_u4F8B_u5316"><a href="#Director_u5B9E_u4F8B_u5316" class="headerlink" title="Director实例化"></a>Director实例化</h3><p>先看看<code>Director</code>的实例化方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">Director* Director::getInstance()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!s_SharedDirector)</span><br><span class="line">    &#123;</span><br><span class="line">        s_SharedDirector = <span class="keyword">new</span> DisplayLinkDirector();</span><br><span class="line">        s_SharedDirector-&gt;init();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s_SharedDirector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> Director::init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    setDefaultValues();</span><br><span class="line"></span><br><span class="line">    _runningScene = <span class="literal">nullptr</span>;</span><br><span class="line">    _nextScene = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    _notificationNode = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化栈大小 */</span></span><br><span class="line">    _scenesStack.reserve(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">    _accumDt = <span class="number">0.0f</span>;</span><br><span class="line">    _frameRate = <span class="number">0.0f</span>;</span><br><span class="line">    _FPSLabel = _drawnBatchesLabel = _drawnVerticesLabel = <span class="literal">nullptr</span>;</span><br><span class="line">    _totalFrames = _frames = <span class="number">0</span>;</span><br><span class="line">    _lastUpdate = <span class="keyword">new</span> <span class="keyword">struct</span> timeval;</span><br><span class="line"></span><br><span class="line">    _paused = <span class="literal">false</span>;</span><br><span class="line">    _purgeDirectorInNextLoop = <span class="literal">false</span>;</span><br><span class="line">    _winSizeInPoints = Size::ZERO;</span><br><span class="line">    _openGLView = <span class="literal">nullptr</span>;</span><br><span class="line">    _contentScaleFactor = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 全局动画管理 */</span></span><br><span class="line">    _scheduler = <span class="keyword">new</span> Scheduler();</span><br><span class="line">    _actionManager = <span class="keyword">new</span> ActionManager();</span><br><span class="line">    _scheduler-&gt;scheduleUpdate(_actionManager, Scheduler::PRIORITY_SYSTEM, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 全局事件分发管理 */</span></span><br><span class="line">    _eventDispatcher = <span class="keyword">new</span> EventDispatcher();</span><br><span class="line">    _eventAfterDraw = <span class="keyword">new</span> EventCustom(EVENT_AFTER_DRAW);</span><br><span class="line">    _eventAfterDraw-&gt;setUserData(<span class="keyword">this</span>);</span><br><span class="line">    _eventAfterVisit = <span class="keyword">new</span> EventCustom(EVENT_AFTER_VISIT);</span><br><span class="line">    _eventAfterVisit-&gt;setUserData(<span class="keyword">this</span>);</span><br><span class="line">    _eventAfterUpdate = <span class="keyword">new</span> EventCustom(EVENT_AFTER_UPDATE);</span><br><span class="line">    _eventAfterUpdate-&gt;setUserData(<span class="keyword">this</span>);</span><br><span class="line">    _eventProjectionChanged = <span class="keyword">new</span> EventCustom(EVENT_PROJECTION_CHANGED);</span><br><span class="line">    _eventProjectionChanged-&gt;setUserData(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化纹理 */</span></span><br><span class="line">    initTextureCache();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化渲染队列 */</span></span><br><span class="line">    _renderer = <span class="keyword">new</span> Renderer;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> (CC_TARGET_PLATFORM != CC_PLATFORM_WINRT) &amp;&amp; (CC_TARGET_PLATFORM != CC_PLATFORM_WP8)</span></span><br><span class="line">    _console = <span class="keyword">new</span> Console;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到这个实例方法，以及初始化函数<code>init</code>，就渐渐对Cocos2dx是怎么开始的，有了一定的了解。</p>
<ul>
<li>Configuration配置一些相关设置，会在setOpenGLView的时候再次更新。</li>
<li>使用cocos2d::Vector来管理场景栈 </li>
<li>初始化全局定时器，全局动坐管理类，全局事件管理类等等。</li>
<li>初始化纹理缓存</li>
<li>初始化渲染队列，Cocos2dx3.0开始，渲染都是放入放入一个渲染队列之中。</li>
<li>其他的就是Director的一些信息的设置啦</li>
</ul>
<h3 id="Director_u4E3B_u5FAA_u73AF"><a href="#Director_u4E3B_u5FAA_u73AF" class="headerlink" title="Director主循环"></a>Director主循环</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> DisplayLinkDirector::startAnimation()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (gettimeofday(_lastUpdate, <span class="literal">nullptr</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        CCLOG(<span class="string">"cocos2d: DisplayLinkDirector: Error on gettimeofday"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _invalid = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    Application::getInstance()-&gt;setAnimationInterval(_animationInterval);</span><br><span class="line">    </span><br><span class="line">    setNextDeltaTimeZero(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 主循环 */</span></span><br><span class="line"><span class="comment">/* 第一个场景运行之后便每一帧调用 */</span></span><br><span class="line"><span class="keyword">void</span> DisplayLinkDirector::mainLoop()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 是否清理 */</span></span><br><span class="line">    <span class="keyword">if</span> (_purgeDirectorInNextLoop)</span><br><span class="line">    &#123;</span><br><span class="line">        _purgeDirectorInNextLoop = <span class="literal">false</span>;</span><br><span class="line">        purgeDirector();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (! _invalid)</span><br><span class="line">    &#123;</span><br><span class="line">        drawScene();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 用于清除那些创建出来，但是没有加入到渲染树中 */</span></span><br><span class="line">        PoolManager::getInstance()-&gt;getCurrentPool()-&gt;clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> DisplayLinkDirector::stopAnimation()</span><br><span class="line">&#123;</span><br><span class="line">    _invalid = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> DisplayLinkDirector::setAnimationInterval(<span class="keyword">double</span> interval)</span><br><span class="line">&#123;</span><br><span class="line">    _animationInterval = interval;</span><br><span class="line">    <span class="keyword">if</span> (! _invalid)</span><br><span class="line">    &#123;</span><br><span class="line">        stopAnimation();</span><br><span class="line">        startAnimation();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>主循环每一帧主要是调用<code>drawScene</code>，主要是计算全局时间间隔，更新全局定时器，全局动作管理，获取输入事件，还有最重要的绘制。</li>
<li>当调用了<code>stopAnimation</code>的时候，即<code>_invalid</code>为false的时候，主循环就什么事情都不干了。</li>
</ul>
<p>PS：对于PoolManager的相关东西见<a href="/2014-10-15/cocos-ccautoreleasepool">cocos2dx 3.0  —- AutoreleasePool, PoolManager</a></p>
<h3 id="Director_u573A_u666F_u7BA1_u7406"><a href="#Director_u573A_u666F_u7BA1_u7406" class="headerlink" title="Director场景管理"></a>Director场景管理</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Director::runWithScene(Scene *scene)</span><br><span class="line">&#123;</span><br><span class="line">    CCASSERT(scene != <span class="literal">nullptr</span>, <span class="string">"This command can only be used to start the Director. There is already a scene present."</span>);</span><br><span class="line">    CCASSERT(_runningScene == <span class="literal">nullptr</span>, <span class="string">"_runningScene should be null"</span>);</span><br><span class="line"></span><br><span class="line">    pushScene(scene);</span><br><span class="line">    startAnimation();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Director::replaceScene(Scene *scene)</span><br><span class="line">&#123;</span><br><span class="line">    CCASSERT(_runningScene, <span class="string">"Use runWithScene: instead to start the director"</span>);</span><br><span class="line">    CCASSERT(scene != <span class="literal">nullptr</span>, <span class="string">"the scene should not be null"</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span> (_nextScene)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_nextScene-&gt;isRunning())</span><br><span class="line">        &#123;</span><br><span class="line">            _nextScene-&gt;onExitTransitionDidStart();</span><br><span class="line">            _nextScene-&gt;onExit();</span><br><span class="line">        &#125;</span><br><span class="line">        _nextScene-&gt;cleanup();</span><br><span class="line">        _nextScene = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ssize_t</span> index = _scenesStack.size();</span><br><span class="line"></span><br><span class="line">    _sendCleanupToScene = <span class="literal">true</span>;</span><br><span class="line">    _scenesStack.replace(index - <span class="number">1</span>, scene);</span><br><span class="line"></span><br><span class="line">    _nextScene = scene;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Director::pushScene(Scene *scene)</span><br><span class="line"><span class="keyword">void</span> Director::popScene(<span class="keyword">void</span>)</span><br><span class="line"><span class="keyword">void</span> Director::popToRootScene(<span class="keyword">void</span>)</span><br><span class="line"><span class="keyword">void</span> Director::popToSceneStackLevel(<span class="keyword">int</span> level)</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Director::end()</span><br><span class="line">&#123;</span><br><span class="line">    _purgeDirectorInNextLoop = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Director::setNextScene()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">bool</span> runningIsTransition = <span class="keyword">dynamic_cast</span>&lt;TransitionScene*&gt;(_runningScene) != <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">bool</span> newIsTransition = <span class="keyword">dynamic_cast</span>&lt;TransitionScene*&gt;(_nextScene) != <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If it is not a transition, call onExit/cleanup</span></span><br><span class="line">     <span class="keyword">if</span> (! newIsTransition)</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">if</span> (_runningScene)</span><br><span class="line">         &#123;</span><br><span class="line">             _runningScene-&gt;onExitTransitionDidStart();</span><br><span class="line">             _runningScene-&gt;onExit();</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         <span class="comment">// issue #709. the root node (scene) should receive the cleanup message too</span></span><br><span class="line">         <span class="comment">// otherwise it might be leaked.</span></span><br><span class="line">         <span class="keyword">if</span> (_sendCleanupToScene &amp;&amp; _runningScene)</span><br><span class="line">         &#123;</span><br><span class="line">             _runningScene-&gt;cleanup();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_runningScene)</span><br><span class="line">    &#123;</span><br><span class="line">        _runningScene-&gt;release();</span><br><span class="line">    &#125;</span><br><span class="line">    _runningScene = _nextScene;</span><br><span class="line">    _nextScene-&gt;retain();</span><br><span class="line">    _nextScene = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((! runningIsTransition) &amp;&amp; _runningScene)</span><br><span class="line">    &#123;</span><br><span class="line">        _runningScene-&gt;onEnter();</span><br><span class="line">        _runningScene-&gt;onEnterTransitionDidFinish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Director::pause()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_paused)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _oldAnimationInterval = _animationInterval;</span><br><span class="line"></span><br><span class="line">    setAnimationInterval(<span class="number">1</span> / <span class="number">4.0</span>);</span><br><span class="line">    _paused = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Director::resume()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (! _paused)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setAnimationInterval(_oldAnimationInterval);</span><br><span class="line"></span><br><span class="line">    _paused = <span class="literal">false</span>;</span><br><span class="line">    _deltaTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    setNextDeltaTimeZero(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>关于<code>runWithScene</code>，由于是开始第一个场景，所以，在入了场景栈之后就开始了Director的主循环。</li>
<li>然后<code>pause</code>，将场景的帧数设置的很低，没有完全停止绘制</li>
<li>然后<code>end</code>只是将一个<code>_purgeDirectorInNextLoop</code>置为true，在下一帧的时候，就执行mainLoop中的清理函数，值得注意的是，清理函数purgeDirector的不会马上释放_scenesStack的内存，主要是因为有可能有人在end之后又调用runWithScene</li>
<li>关于<code>_nextScene</code>和<code>_runningScene</code>的关系，在下一帧的时候，_nextScene会被赋值给_runningScene，然后被置空，具体见drawScene和setNextScene</li>
</ul>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>有关于GLView的部分需要另外写一篇文章来讲，这里就不说了，然后Director的代码我也略去了与openGL相关的一些东西，这些东西留作以后补充。</p>
<hr>
<p>其实看完Director的代码之后，很容易就可以知道从哪里去阅读Cocos2dx源码。</p>
<ul>
<li>配置文件部分</li>
<li>渲染机制     – Render, RenderCommand…</li>
<li>时间分发机制 – EventDispatcher</li>
<li>动作管理     – ActionManager</li>
<li>GLView       – openGL相关 </li>
</ul>
	  

	  <div>
  		<center>
		  <div class="pagination">
<ul class="pagination">
	
	
	
	
	
	
		
	
		
	
		
	
		
	
		
	
		
			
		
	
		
	
		
			
		
	
		
	
		
	
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
			
		
	
		
			
			
			
		
	
		
			
		
	
		
			
		
	
		
	
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
	
		
			
		
	
		
	
	
	
		<li class="prev"><a href="/2014/11/24/cocos-appdelegate/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>prev</a></li>
	
	<li><a href="/"><i class="fa fa-archive"></i>Home</a></li>
	
		<li class="next"><a href="/2014/11/22/cocos-lua/" class="alignright next">next<i class="fa fa-arrow-circle-o-right"></i></a></li>
	
</ul>
</div>

		</center>
	  </div>
	  
	</div> <!-- col-md-9/col-md-12 -->
	
  </div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
	<footer> <p>
  &copy; 2016 John Doe
  
      with help from <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-wixo/">Wixo</a>.    
</p> </footer>
  </div> <!-- container-narrow -->
  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.tableofcontents.min.js"></script>
<script src="/js/tocgenerator.min.js"></script>
<script src="/js/main.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
</html>
